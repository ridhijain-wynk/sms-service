@Library('shared-library') _
pipeline {
    agent {
        node {
            label "wcf-prod"
        }
    }
    options {
    buildDiscarder(logRotator(numToKeepStr: '5', artifactNumToKeepStr: '5'))
    }
    parameters {
        string(name: 'BRANCH_NAME', defaultValue: 'stagingGCP', description: 'Enter the branch to be deployed')
        booleanParam(name: 'DevSecOps', defaultValue: false, description: 'Blackduck and coverity Security scan')
    }
    environment {
        region = 'asia-south1-docker.pkg.dev'
        projet_name = 'prj-wynk-pre-wcf-svc-01'
        repo_name = 'pre-wcf-sms'
        working_dir = 'infra'
        env_e  = 'preprod'
        git_url = "https://github.com/WynkLimited/sms-service"
        jar_name = "wynk-sms-0.0.1.jar"
        // Argo Deploy specific var's
        service_name = "sms"
        app_env = "pre-prod"
        build_job = "wcf-preprod-cmn-deployment"
        image_repo = "${region}\\/${projet_name}\\/${repo_name}\\/${repo_name}"
        variablesBranch = "wcf-preprod"
        repo = "wcf-sms"
        jiraId = "WCF-123"
        
    }

    stages {
        stage('Code Checkout') {
            steps {
                checkout([$class: 'GitSCM', branches: [[name: '${BRANCH_NAME}']], extensions: [], userRemoteConfigs: [[credentialsId: 'wynkdeployment', url: git_url]]])
            }
        }
        
        stage('Code Build ') {
            steps {
                sh """
                echo "build_job: $build_job || service_name: $service_name || app_env: $app_env || repo_name: $repo_name"
                export JAVA_HOME=/opt/JavaVersions/jdk1.8.0_202
                export PATH=/opt/JavaVersions/jdk1.8.0_202/bin:$PATH
                PATH=$PATH:/opt/MavenVersions/apache-maven-3.3.9/bin/
                echo $PATH
                /opt/MavenVersions/apache-maven-3.3.9/bin/mvn -Denv=preprod -s /opt/ConfigWCF/settings.xml clean install -P sms -am -Denv=$env_e
                """
            }
        }
        stage('Image Build & GAR push') {
            steps {
                sh '''
                pwd
                cd /mnt/jenkins/workspace/${JOB_NAME}/wynk-sms/infra/docker
                cp /mnt/jenkins/workspace/${JOB_NAME}/wynk-sms/build/${jar_name} /mnt/jenkins/workspace/${JOB_NAME}/wynk-sms/infra/docker
                cp /opt/NewRelic/newrelic/newrelic.jar /mnt/jenkins/workspace/${JOB_NAME}/wynk-sms/infra/docker
                gcloud auth configure-docker ${region}
                docker build --build-arg profile=$env_e -t ${region}/${projet_name}/${repo_name}/${repo_name}:${BUILD_NUMBER} -f Dockerfile .
                docker login ${region}/${projet_name}/${repo_name}
                docker push ${region}/${projet_name}/${repo_name}/${repo_name}:${BUILD_NUMBER}
                '''
           }
        }

        stage('SAST and SCA Security Checks') {
  steps {
    dir('wynk-sms'){
    withEnv(["PATH=/opt/JavaVersions/jdk1.8.0_202/bin:$PATH"]) {
      withCredentials([string(credentialsId: 'jenkins-github-token-secret', variable: 'GITHUB_TOKEN')]) {
        script {
          if (params.DevSecOps == true) {
              // üì• Load GitHub JSON config
              def url = "https://api.github.com/repos/WynkLimited/security-altmasterpipeline/contents/mavenrepos.json?ref=${env.variablesBranch}"
              def rawJson = sh(
                script: """
                  set +x
                  curl -s -H "Authorization: token \$GITHUB_TOKEN" \\
                           -H "Accept: application/vnd.github.v3.raw" \\
                           "${url}"
                """,
                returnStdout: true
              ).trim()

              def parsedJson = readJSON text: rawJson
              def repoList = parsedJson.repositories
              def repoData = repoList.find { it.bitbucketRepoName == env.repo }

              if (!repoData) {
                error "‚ùå Repository '${env.repo}' not found in mavenrepos.json"
              }

              // üì¶ Set required values
              repoData.put("currentBranchName", BRANCH_NAME)
              repoData.put("JIRA_ID_OR_CHANGE_ID", env.jiraId)

              echo "‚úÖ SCA/SAST Scan Input: ${repoData}"

              // üöÄ Run the shared library (which internally calls synopsys_detect)
              commitchangeset(repoData)
          }
        }
      }
     }
    }
  }
}

        stage('ArgoCD Deployment') {
            steps {
                build job: "$build_job", parameters: [[$class: 'StringParameterValue', name: 'APP_ENV', value: "${app_env}"], [$class: 'StringParameterValue', name: 'SERVICE_NAME', value: "${service_name}"], [$class: 'StringParameterValue', name: 'IMAGE_REPO', value: "${image_repo}"], [$class: 'StringParameterValue', name: 'IMAGE_TAG', value: "${BUILD_NUMBER}"]] , wait: true
            }
        }
    }
    post {
        always {
            cleanWs()
        }
    }
}